name: DVC Auto-Check

on:
  push:
    branches:
      - develop
      - 'feature/**'

jobs:
  dvc:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install DVC
        run: pip install dvc dvc-onedrive

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup DVC Remote (OneDrive)
        env:
          # Diese Secrets musst du in GitHub anlegen
          OD_CLIENT_ID: ${{ secrets.ONEDRIVE_CLIENT_ID }}
          OD_CLIENT_SECRET: ${{ secrets.ONEDRIVE_CLIENT_SECRET }}
          OD_REFRESH_TOKEN: ${{ secrets.ONEDRIVE_REFRESH_TOKEN }}
        run: |
          # Remote f√ºr OneDrive setzen
          dvc remote add -d storage onedrive://dvc-data --force
          # Authentifizierung konfigurieren
          dvc remote modify --local storage client_id "$OD_CLIENT_ID"
          dvc remote modify --local storage client_secret "$OD_CLIENT_SECRET"
          dvc remote modify --local storage refresh_token "$OD_REFRESH_TOKEN"

      - name: Run DVC auto-add
        run: bash scripts/dvc_auto_add.sh

      - name: Push to OneDrive and Git
        run: |
          dvc push
          git push origin HEAD:${{ github.ref_name }}